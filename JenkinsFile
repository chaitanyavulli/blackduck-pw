#!/user/bin/env groovy
import org.jenkinsci.plugins.pipeline.modeldefinition.Utils
node('blackduck-scan')
{
timestamps{
	properties([
		parameters([
			string(defaultValue: 'network', description: 'Defining parameter for repository name', name: 'REPOSITORY_NAME', trim: false),
			string(defaultValue: 'develop', description: 'Defining parameter for branch name', name: 'PW_BRANCH', trim: false),
		])
	])
	def BDToken="MTdiOWNkYTQtZDA2Yy00YzBhLTk0MzctMDMxMzU4MGQ0YWY1OjU3ODZjOGM4LTVkMDYtNDA0ZS1iNWNhLTVlMDYzZTg4ZTVhNw=="
	def verCode = UUID.randomUUID().toString()
	
	currentBuild.displayName = "#${BUILD_NUMBER}, ${REPOSITORY_NAME}"
	currentBuild.description = "#${BUILD_NUMBER}, ${PW_BRANCH}"
	dir("${verCode}")
	{
		try{
			stage('Fetch Product Repository'){
				//checkout([$class: 'GitSCM', branches: [[name: '*/${PW_BRANCH}']], extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: '${REPOSITORY_NAME}'], [$class: 'GitLFSPull'], [$class: 'ScmName', name: '${REPOSITORY_NAME}']], userRemoteConfigs: [[credentialsId: 'e8ff24f6-10d1-4129-8c70-7c66d7c2d6d7', url: 'ssh://git@git.parallelwireless.net:7999/cd/${REPOSITORY_NAME}.git']]])
				if ("${REPOSITORY_NAME}" == "rt-monitoring")
				{
					checkout([$class: 'GitSCM', branches: [[name: '*/${PW_BRANCH}']], extensions: [[$class: 'ScmName', name: '${REPOSITORY_NAME}'], [$class: 'RelativeTargetDirectory', relativeTargetDir: '${REPOSITORY_NAME}'], [$class: 'GitLFSPull'], [$class: 'LocalBranch', localBranch: '${PW_BRANCH}']], userRemoteConfigs: [[credentialsId: 'vaultpwbldmgr', url: 'https://nhbbm.parallelwireless.net/scm/git/da/${REPOSITORY_NAME}.git']]])
				}
				else if ("${REPOSITORY_NAME}" == "bbpms_bsp"){
					checkout([$class: 'GitSCM', branches: [[name: '*/${PW_BRANCH}']], extensions: [[$class: 'ScmName', name: '${REPOSITORY_NAME}'], [$class: 'RelativeTargetDirectory', relativeTargetDir: '${REPOSITORY_NAME}'], [$class: 'GitLFSPull'], [$class: 'LocalBranch', localBranch: '${PW_BRANCH}']], userRemoteConfigs: [[credentialsId: 'vaultpwbldmgr', url: 'https://nhbbm.parallelwireless.net/scm/git/bsp/${REPOSITORY_NAME}.git']]])

				}
				else if("${REPOSITORY_NAME}" == "uniperf"){
					checkout([$class: 'GitSCM', branches: [[name: '*/${PW_BRANCH}']], extensions: [[$class: 'ScmName', name: '${REPOSITORY_NAME}'], [$class: 'RelativeTargetDirectory', relativeTargetDir: '${REPOSITORY_NAME}'], [$class: 'GitLFSPull'], [$class: 'LocalBranch', localBranch: '${PW_BRANCH}']], userRemoteConfigs: [[credentialsId: 'vaultpwbldmgr', url: 'https://nhbbm.parallelwireless.net/scm/git/tool/${REPOSITORY_NAME}.git']]])
				}
				else if("${REPOSITORY_NAME}" == "ems")
				{
					checkout([$class: 'GitSCM', branches: [[name: '*/${PW_BRANCH}']], extensions: [[$class: 'ScmName', name: '${REPOSITORY_NAME}'], [$class: 'RelativeTargetDirectory', relativeTargetDir: '${REPOSITORY_NAME}'], [$class: 'GitLFSPull'], [$class: 'LocalBranch', localBranch: '${PW_BRANCH}']], userRemoteConfigs: [[credentialsId: 'vaultpwbldmgr', url: 'https://nhbbm.parallelwireless.net/scm/git/um/${REPOSITORY_NAME}.git']]])
				}
                else if("${REPOSITORY_NAME}" == "near_rtric")
				{
					checkout([$class: 'GitSCM', branches: [[name: '*/${PW_BRANCH}']], extensions: [[$class: 'ScmName', name: '${REPOSITORY_NAME}'], [$class: 'RelativeTargetDirectory', relativeTargetDir: '${REPOSITORY_NAME}'], [$class: 'GitLFSPull'], [$class: 'LocalBranch', localBranch: '${PW_BRANCH}']], userRemoteConfigs: [[credentialsId: 'vaultpwbldmgr', url: 'https://nhbbm.parallelwireless.net/scm/git/near/${REPOSITORY_NAME}.git']]])
				}
				else{
					checkout([$class: 'GitSCM', branches: [[name: '*/${PW_BRANCH}']], extensions: [[$class: 'ScmName', name: '${REPOSITORY_NAME}'], [$class: 'RelativeTargetDirectory', relativeTargetDir: '${REPOSITORY_NAME}'], [$class: 'GitLFSPull'], [$class: 'LocalBranch', localBranch: '${PW_BRANCH}']], userRemoteConfigs: [[credentialsId: 'vaultpwbldmgr', url: 'https://nhbbm.parallelwireless.net/scm/git/cd/${REPOSITORY_NAME}.git']]])
				}
			}
			stage('Build Product'){
				REPONAME = "${REPOSITORY_NAME}".replaceAll("-","");
				if ("$REPONAME" == "2gstack")
				{
					REPONAME="twogstack"
				}
				"$REPONAME"()
			}
			def projectSourcePath=""
			if ("${REPOSITORY_NAME}" == "network")
			{
				projectSourcePath = "${WORKSPACE}/${verCode}/${REPOSITORY_NAME}/hng"
			}
			else if ("${REPOSITORY_NAME}" == "core")
			{
				projectSourcePath = "${WORKSPACE}/${verCode}/${REPOSITORY_NAME}/vru"
			}
			else if ("${REPOSITORY_NAME}" == "core-stacks")
			{
				projectSourcePath = "${WORKSPACE}/${verCode}/${REPOSITORY_NAME}/ltestack"
			}
			else
			{
				projectSourcePath = "${WORKSPACE}/${verCode}/${REPOSITORY_NAME}/"
			}
			//sizeWorkspace = "${WORKSPACE}/${verCode}/${REPOSITORY_NAME}".size()
			sizeWorkspace = sh(script:"du -sk \${REPOSITORY_NAME}/ | awk '{print \$1}'", returnStdout: true).toInteger()
			echo "Workspace Size = ${sizeWorkspace}"
			
			if ("${sizeWorkspace}".toInteger() > 5242880)
			{
			catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
				stage('Blackduck Analysis'){
					dir("${REPOSITORY_NAME}"){
						sh """
							find . -empty -type d -delete
							/opt/bd_tools/enhanced-splitter.sh "${REPOSITORY_NAME}" develop-HEAD "${REPOSITORY_NAME}" "${REPOSITORY_NAME}" "$projectSourcePath"
						"""
					}
				}
			}
			}
			else
			{
				catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
				stage('Blackduck Analysis'){
					dir("${REPOSITORY_NAME}"){
						sh """
							curl -O 'https://detect.synopsys.com/detect.sh'
							chmod +x detect.sh
							./detect.sh --blackduck.url=https://parallelwireless.app.blackduck.com --blackduck.api.token="${BDToken}" --detect.project.name="${REPOSITORY_NAME}" --detect.source.path="$projectSourcePath" --detect.code-location.name="${REPOSITORY_NAME}-develop-HEAD" --detect.project.version.name=develop-HEAD --detect.project.version.update=true --detect.timeout=900
						"""
					}
				}
				}
			}
			stage('Generating Report'){
                                dir("${REPOSITORY_NAME}"){
				sh """
					sh /work/sa.pw-bldmgr/blackduck_csv_reports/blackduckProjectReport.sh ${REPOSITORY_NAME} develop-HEAD
				"""
                                }
						sh '''
						
text="
Hi
						
Blackduck analysis for ${REPOSITORY_NAME} completed. Please find the attachment to view the result
						
Build URL : ${BUILD_URL}

Thanks
"
						echo "$text" > mailBody.txt
						
						cat mailBody.txt | mail -s "${BUILD_DISPLAY_NAME}- BLACKDUCK - ${BUILD_NUMBER}" -r 'buildmgr@parallelwireless.com' releng@parallelwireless.com
						'''
			}
            currentBuild.result = 'SUCCESS'
        }
        catch (Exception Error) {
						sh '''
						
text="
Hi
						
Blackduck analysis for ${REPOSITORY_NAME} has failed. Please check
					
Build URL : ${BUILD_URL}
Thanks
"
						echo "$text" > mailBody.txt
						
						cat mailBody.txt | mail -s "${BUILD_DISPLAY_NAME}-BLACKDUCK - ${BUILD_NUMBER} has failed" -r 'buildmgr@parallelwireless.com' releng@parallelwireless.com
						'''
						throw Error
						currentBuild.result = 'FAILURE'
        }
		finally{
			cleanWs()
		}
	}
}//end of timestamps
}//end of node


def network()
{
	dir('network'){
		sh '''
		cd hng/ci_scripts/build/
		python hng-build.py build-docker
		python hng-build.py make clean.all
		python hng-build.py ci_scripts/build/get-3rd-party-pkgs.py
		python hng-build.py ./buildarchive.sh lacrpm 6
		'''
	}
}
def vru4gphy()
{
	dir('vru-4g-phy'){
		sh '''
			export GIT_COMMIT=$(git rev-parse HEAD)
			sh -xe ci-build.sh
		'''
	}
}
def vru3gphy()
{
	dir('vru-3g-phy'){
		sh '''
			export GIT_COMMIT=$(git rev-parse HEAD)
			sh -xe ci-build.sh
		'''
	}
}
def vru2gphy()
{
	dir('vru-2g-phy'){
		sh '''
			export GIT_COMMIT=$(git rev-parse HEAD)
			sh -xe ci-build.sh
		'''
	}
}
def vru5gphy()
{
	dir('vru-5g-phy'){
		sh '''
			export GIT_COMMIT=$(git rev-parse HEAD)
			sh -xe ci-build.sh
		'''
	}
}
def corestacks(){
	dir('core-stacks'){
	    def uid = sh(label: "Read user UID", returnStdout: true, script: "id -u").trim()
        def gid = sh(label: "Read user GID", returnStdout: true, script: "id -g").trim()
        def group = sh(label: "Read user group name", returnStdout: true, script: "id -gn").trim()
        def current_dir = pwd()

        image = docker.build(
            "core-stacks:core-stacks",
                "--build-arg HOME=${HOME} \
                 --build-arg UID=${uid} \
                 --build-arg USER=${USER} \
                 --build-arg GID=${gid} \
                 --build-arg GROUP=${group} \
                 --build-arg PWD=${current_dir} \
                 --build-arg BRANCH=${PW_BRANCH} \
                 -f docker/Dockerfile.user docker"
        )
		image.inside('-v"${HOME}":${HOME}') {
				sh 'make fdd.x86.install.6'
                sh 'make fdd.x86.install.8'
                sh 'make fdd.t2k.install'
                //sh 'make fdd.t3k.install'
                sh 'make tdd.t2k.install'
        }
		
	}
}
def osmo2g(){
	dir('osmo2g'){
        def uid = sh(label: "Read user UID", returnStdout: true, script: "id -u").trim()
        def gid = sh(label: "Read user GID", returnStdout: true, script: "id -g").trim()
        def group = sh(label: "Read user group name", returnStdout: true, script: "id -gn").trim()
        def current_dir = pwd()
        image = docker.build(
            "osmo2g:osmo2g",
            "--build-arg HOME=${HOME} \
             --build-arg UID=${uid} \
             --build-arg USER=${USER} \
             --build-arg GID=${gid} \
             --build-arg GROUP=${group} \
             --build-arg PWD=${current_dir} \
             -f docker/Dockerfile.user docker"
        )
		image.inside('-v"${HOME}":${HOME}') {
            sh 'make osmo-2g.dist'
        }
	}
}
def twogstack(){
	dir('2g-stack'){
		def uid = sh(label: "Read user UID", returnStdout: true, script: "id -u").trim()
        def gid = sh(label: "Read user GID", returnStdout: true, script: "id -g").trim()
        def group = sh(label: "Read user group name", returnStdout: true, script: "id -gn").trim()
        def current_dir = pwd()
        image = docker.build(
            "2g-stack:2g-stack",
            "--build-arg HOME=${HOME} \
             --build-arg UID=${uid} \
             --build-arg USER=${USER} \
             --build-arg GID=${gid} \
             --build-arg GROUP=${group} \
             --build-arg PWD=${current_dir} \
             -f docker/Dockerfile.user docker"
        )
		image.inside('-v"${HOME}":${HOME}') {
            sh """
				pwd
				ls
				make 2g.dist
			"""
        }
	}
}
def core()
{
	dir('core/vru'){
		sh """
			sh -xe ci-build.sh
		"""
	}
}
def nodeh()
{
	dir('nodeh'){
		def uid = sh(label: "Read user UID", returnStdout: true, script: "id -u").trim()
        def gid = sh(label: "Read user GID", returnStdout: true, script: "id -g").trim()
        def group = sh(label: "Read user group name", returnStdout: true, script: "id -gn").trim()
        def current_dir = pwd()

        image = docker.build(
            "nodeh:nodeh",
            "--build-arg HOME=${HOME} \
             --build-arg UID=${uid} \
             --build-arg USER=${USER} \
             --build-arg GID=${gid} \
             --build-arg GROUP=${group} \
             --build-arg PWD=${current_dir} \
             -f docker/Dockerfile.user docker"
        )
        image.inside('-v"${HOME}":${HOME}') {
            // new setup process (cmake)
            dir("source") {
                sh 'rm -rf ../build_li32 ../build_li64 ../build_hw ../build_sources ../trace'
                sh './setup_hw -c 900'
                sh 'source /opt/intel/system_studio_2019/bin/compilervars.sh intel64; ./setup_hw -t -p8'
            }		
	    }
    }
}
def cwsrrh(){
	dir('cws-rrh'){
		sh """
			sh -xe build.sh 2g-ceva
			sh -xe build.sh 3g-ceva
		"""
	}
}
def pnfvnf(){
	dir('pnf-vnf'){
	    def uid = sh(label: "Read user UID", returnStdout: true, script: "id -u").trim()
        def gid = sh(label: "Read user GID", returnStdout: true, script: "id -g").trim()
        def group = sh(label: "Read user group name", returnStdout: true, script: "id -gn").trim()
        def current_dir = pwd()

        image = docker.build(
            "pnf-vnf:pnf-vnf",
            "--build-arg HOME=${HOME} \
             --build-arg UID=${uid} \
             --build-arg USER=${USER} \
             --build-arg GID=${gid} \
             --build-arg GROUP=${group} \
             --build-arg PWD=${current_dir} \
             -f docker/Dockerfile.user docker"
        )
                    image.inside('-v"${HOME}":${HOME}') {
                        dir("PW/product") {
                            def uncrustify_ignore = "\
                                -not -path '*/do/*' \
                                -not -path '*/import/*' \
                                -not -path '*/common/codecs/interface/*' \
                                -not -path '*/tests/*' \
                                -not -path '*/framework/logging/interface/loggingUtils_if.hpp' \
                                -not -path '*/pnf/downlink/module/decodeFsm.cpp' \
                                -not -path '*/pnf/downlink/module/decodeMessage.cpp' \
                                -not -path '*/pnf/downlink/module/downlinkP7.cpp' \
                                -not -path '*/pnf/uplink/module/encode.cpp' \
                                -not -path '*/pnf/uplink/module/uplink.cpp' \
                                -not -path '*/pnf/uplink/module/discardTimer.cpp' \
                                -not -path '*/pnf/uplink/module/tl_kheap.h' \
                                -not -path '*/pnf/main/module/pnfMain.cpp' \
                                -not -path '*/pnf/main/module/tl_kheap.h' \
                                -not -path '*/vnf/commsUl/module/commsUl.hpp' \
                                -not -path '*/vnf/commsUl/module/commsUlHandler.cpp' \
                                -not -path '*/vnf/commsUl/module/decode.cpp' \
                                -not -path '*/vnf/commsDl/module/commsDlHandler.cpp' \
                                "
                            def uncrustify_files = sh(
                                label: "Find files",
                                script: "\
                                    find -type f \
                                    -regextype posix-extended \
                                    -regex '.*\\.[ch](pp)?\$' \
                                    ${uncrustify_ignore} \
                                    -printf '%p ' \
                                ",
                                returnStdout: true
                            )
                            
                            sh(
                                label: "Run uncrustify",
                                script: "\
                                    ../../tools/uncrustify/uncrustify --check \
                                    -c ../../tools/uncrustify/accelleran.cfg \
                                    ${uncrustify_files} \
                                "
                            )
                        }
                    }
                    image.inside('-v"${HOME}":${HOME}') {
                        full_hash = sh(
                            label: "Get short commit hash",
                            returnStdout: true,
                            script: "git log --format=format:%H -n 1"
                        ).trim()


                        def threadCount = sh(
                            label: "Read jobs count",
                            returnStdout: true,
                            script: "nproc --all"
                        ).trim()
                        
                        dir("PW/product") {
                            sh(
                                label: "Build TTCN Test",
                                script: "\
                                    scons -j${threadCount} \
                                    --buildApplication=APPL-FDD \
                                    --buildMode=CONTINUOUS \
                                    --buildType=TTCNTEST \
                                    --logSeverity=DEBUG_SEVERITY \
                                    --wls-dpdk \
                                    pwApplExe \
                                "
                            )

                            sh(
                                label: "Build Product",
                                script: "\
                                    scons -j${threadCount} \
                                    --buildApplication=APPL-FDD \
                                    --buildMode=CONTINUOUS \
                                    --buildType=PRODUCTION \
                                    --logSeverity=ERROR_SEVERITY \
                                    --wls-dpdk \
                                    pwApplExe \
                                "
                            )
						}
					}
	}
}
def nrstack(){
	dir('nr-stack'){
                    def uid = sh(label: "Read user UID", returnStdout: true, script: "id -u").trim()
                    def gid = sh(label: "Read user GID", returnStdout: true, script: "id -g").trim()
                    def group = sh(label: "Read user group name", returnStdout: true, script: "id -gn").trim()
                    def current_dir = pwd()

                    image = docker.build(
                        "nr-stacks:nr-stacks",
                        "--build-arg HOME=${HOME} \
                         --build-arg UID=${uid} \
                         --build-arg USER=${USER} \
                         --build-arg GID=${gid} \
                         --build-arg GROUP=${group} \
                         --build-arg PWD=${current_dir} \
                         -f docker/Dockerfile.user docker"
                    )
                    image.inside('-v"${HOME}":${HOME}') {
                        /* fail on error
                        sh """
                            sh -xe build.sh all sa intel
                        """
                        */
                        sh './build.sh all sa intel'
                    }
					image.inside('-v"${HOME}":${HOME}') {
                        full_hash = sh(
                            label: "Get full commit hash",
                            returnStdout: true,
                            script: "git log --format=format:%H -n 1"
                        ).trim()
                        /* fail on error
                        sh """
                            sh -xe build.sh all sa host
                        """
                        */
                        sh 'free -g'
                        sh './build.sh all sa host'
                    }
	
	}
}
def pwconfig(){
	dir('pwconfig'){

	}
}
def pwgui(){
	dir('pwgui/deploy'){
        echo "branch ${PW_BRANCH}"
        commit_time = sh (script: 'date -d @`git show -s --format=%ct HEAD` +"%Y%m%d.%H%M"',returnStdout: true).trim()
        short_commit_hash = sh (script: 'git rev-parse --short=8 HEAD',returnStdout: true).trim()
        echo "commit_hash $commit_time"
        echo "Calling the Docker Build Script..."
        sh """
			sh -xe ci-build.sh ${PW_BRANCH} ${short_commit_hash} ${commit_time}
        """	
	}
}
def rtmonitoring(){
	dir('rt-monitoring'){
	
	}
}
def bbpms_bsp(){
	dir('bbpms_bsp'){
        def uid = sh(label: "Read user UID", returnStdout: true, script: "id -u").trim()
        def gid = sh(label: "Read user GID", returnStdout: true, script: "id -g").trim()
        def group = sh(label: "Read user group name", returnStdout: true, script: "id -gn").trim()
        def current_dir = pwd()

		docker_image = docker.build(
            "bbpms_bsp:bbpms_bsp",
            "--build-arg HOME=${HOME} \
             --build-arg UID=${uid} \
             --build-arg USER=${USER} \
             --build-arg GID=${gid} \
             --build-arg GROUP=${group} \
             --build-arg PWD=${current_dir} \
             -f docker/Dockerfile docker"
        )
        docker_image.inside('-v"${HOME}":${HOME}') {
            sh 'pwd'
            sh 'make clean'
            sh 'make mag_install'
        }
	}
}
def ciphapp(){
	dir('ciph-app'){
        sh '''
        echo "Building: ciph-app"
                  chmod +x ci-build.sh
                  pwd
                  ./ci-build.sh
        '''
	}
}
def uniperf(){
	dir('uniperf'){
	
	}
}
def ems(){
	dir('ems'){
		sh '''
			export ELEMENTS_ROOT=$(pwd)
			export ELEMENTS_BUILD=$ELEMENTS_ROOT/build
			export JAVA_HOME=/usr/java/jdk1.8.0_102
			export CL_COMMONS_BUILD=$ELEMENTS_BUILD/centeredlogic-commons
			export ELEMENTS_RUN=$ELEMENTS_ROOT/run
			export MODULE_NAME=UniCloud
			export NETCONFX_BUILD=$ELEMENTS_BUILD/netconfX
			export ELEMENTS_DIST=$ELEMENTS_ROOT/dist/uni-manage
			export PRODUCT_NAME=unimanage
			export ANT_HOME=/opt/apache-ant-1.9.7
			export PATH=/usr/java/jdk1.8.0_102/bin:${ANT_HOME}/bin:/opt/swtools/bin/git/bin:/opt/cov-analysis-latest/bin:/usr/lib64/qt-3.3/bin:/opt/maven/bin:/opt/swtools/bin/git/bin/:/usr/local/bin:/usr/bin:/opt/swtools/bin/depot_tools/jfrog_CLI/:/usr/sbin:/opt/maven/bin:/opt/swtools/bin/depot_tools/jfrog_CLI/
			export ELEMENTS_SOURCE=$ELEMENTS_ROOT/3rdPartySource/centeredlogic/elementcenter
			cd unimanage
			/opt/apache-ant-1.9.7/bin/ant -file build.xml -DPW_BRANCH=release/REL_4.2.0 -DBUILD_VERSION=4.2.0.4 -DPW_TAG_PREFIX=EMS -DPW_BUILD_EPOCH=1622146231 -Ddebug=true release
		'''
	}
}

def near_rtric(){
	dir('near_rtric'){
            sh """
            git submodule update --init
            """	
	}
}

def corestacksphy(){
	dir('core-stacks-phy/4gPhy/'){
            sh '''
            echo "building arm"
            ./ci-build.sh
            '''
        }    
}
